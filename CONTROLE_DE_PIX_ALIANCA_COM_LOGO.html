<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CONTROLE DE PIX ALIAN√áA</title>
<style>
  :root{
    --primary:#004d2b;
    --accent:#ffb400;
    --card:#fff;
    --muted:#6b7280;
  }
  html,body{height:100%}
  body{font-family:Arial,Helvetica,sans-serif;background:#f3f4f6;margin:0;color:#222;min-height:100%}
  .wrap{max-width:980px;margin:18px auto;padding:18px}
  header{
    display:flex;align-items:center;justify-content:space-between;
    background:linear-gradient(135deg,var(--primary),#1e8449);
    color:#fff;padding:14px 18px;border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,.2)
  }
  header h1{margin:0;font-size:20px;letter-spacing:1px}
  
  .top-fixed{margin-top:12px;background:linear-gradient(180deg, rgba(31,91,47,0.06), rgba(31,91,47,0.03));border:1px solid rgba(31,91,47,0.08);padding:12px;border-radius:8px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .top-fixed .label{font-weight:700;color:var(--primary);min-width:120px}
  .card{background:var(--card);padding:14px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-top:14px}
  label{display:block;font-weight:700;margin-top:10px;color:#111}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1;min-width:200px}
  input[type="text"],input[type="date"],input[type="number"],select,textarea{
    width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;background:#fff
  }
  input[readonly]{background:#f6f6f6;border-color:#e6e6e6;color:#333}
  .actions{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  button{
    background:var(--primary);color:#fff;border:0;padding:10px 12px;border-radius:8px;
    cursor:pointer;font-weight:700;transition:all 0.2s ease
  }
  button.secondary{background:var(--muted)}
  button:hover{opacity:0.9;transform:scale(1.03)}
  .summary{background:#fff;padding:12px;border-radius:8px;margin-top:14px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
  table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:8px;overflow:hidden}
  th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
  th{background:var(--primary);color:#fff;font-weight:700}
  td.actions{white-space:nowrap}
  .delete-btn{background:#dc3545;color:#fff;border:0;padding:6px 8px;border-radius:6px;cursor:pointer}
  .delete-btn:hover{opacity:0.9;transform:scale(1.05)}
  footer{margin-top:18px;text-align:center;color:#666;font-size:13px}
  .small-muted{font-size:13px;color:#666}
  @media(max-width:720px){.row{flex-direction:column}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><img src="logo_alianca.png" alt="Logo Alian√ßa" style="height:40px;vertical-align:middle;margin-right:10px;"> CONTROLE DE PIX ALIAN√áA</h1>
      <div id="top-summary" style="font-size:14px">Total: 0 ‚Äî Soma: R$ 0,00</div>
    </header>

    <div id="motoristaBlock" class="top-fixed card" aria-live="polite"></div>

    <div class="card">
      <form id="pixForm" autocomplete="off">
        <div class="row">
          <div class="col">
            <label for="cliente">Cliente</label>
            <input id="cliente" name="cliente" type="text" placeholder="Nome do cliente" required />
          </div>
          <div class="col">
            <label for="dataPix">Data do PIX</label>
            <input id="dataPix" name="dataPix" type="date" required />
          </div>
          <div class="col">
            <label for="valorPix">Valor (R$)</label>
            <input id="valorPix" name="valorPix" type="text" inputmode="decimal" placeholder="R$ 0,00" required />
          </div>
          <div class="col">
            <label for="conferidoPor">Conferido por</label>
            <input id="conferidoPor" name="conferidoPor" type="text" placeholder="Nome de quem conferiu" />
          </div>
        </div>
        <div class="actions">
          <button type="submit">‚ûï Adicionar Entrada</button>
          <button type="button" class="secondary" onclick="exportarExcel()">üìä Exportar Excel</button>
          <button type="button" class="secondary" onclick="imprimirResumo()">üñ®Ô∏è Imprimir</button>
          <button type="button" class="secondary" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
        </div>
      </form>
    </div>

    <div id="lista" class="summary">
      <strong>Registros</strong>
      <div id="tabela-container"></div>
    </div>

    <footer>Desenvolvido por <strong>Neidivan Ribeiro</strong> ‚Ä¢ Sistema: <strong>CONTROLE DE PIX ALIAN√áA</strong></footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script>
  const formatBRL = (v) => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(v || 0));
  function parseBRL(str){
    if (!str) return 0;
    let s = String(str).trim().replace(/[^\d\-,.]/g,'');
    const lastComma = s.lastIndexOf(',');
    const lastDot = s.lastIndexOf('.');
    if (lastComma > lastDot){ s = s.replace(/\./g,'').replace(',', '.'); }
    else { s = s.replace(/,/g,''); }
    const num = parseFloat(s);
    return isNaN(num) ? 0 : num;
  }
  function escapeHtml(text){
    if (!text && text !== 0) return '';
    return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  const motoristaBlock = document.getElementById('motoristaBlock');
  const form = document.getElementById('pixForm');
  const tabelaContainer = document.getElementById('tabela-container');
  const topSummary = document.getElementById('top-summary');
  const valorInput = document.getElementById('valorPix');

  valorInput.addEventListener('input', e => e.target.value = e.target.value.replace(/[^\d,.\-]/g,''));
  valorInput.addEventListener('blur', e => e.target.value = formatBRL(parseBRL(e.target.value)));
  valorInput.addEventListener('focus', e => { const n = parseBRL(e.target.value); e.target.value = n ? n.toString().replace('.',',') : ''; });

  const KEY_REGS = 'pix_registros';
  const KEY_MOTORISTA = 'pix_motorista';
  const KEY_ROMANEIO = 'pix_romaneio';

  function carregarRegistros(){ return JSON.parse(localStorage.getItem(KEY_REGS) || '[]'); }
  function salvarRegistros(regs){ localStorage.setItem(KEY_REGS, JSON.stringify(regs)); }

  function renderMotoristaBlock(){
    const motorista = localStorage.getItem(KEY_MOTORISTA);
    const romaneio = localStorage.getItem(KEY_ROMANEIO);

    if (!motorista || !romaneio) {
      motoristaBlock.innerHTML = `
        <div style="flex:1;min-width:220px">
          <label style="font-weight:700;color:var(--primary);margin-bottom:6px;display:block">Motorista (preenchimento 1¬™ vez)</label>
          <input id="first_motorista" type="text" placeholder="Nome do motorista" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:100%" />
        </div>
        <div style="flex:1;min-width:180px">
          <label style="font-weight:700;color:var(--primary);margin-bottom:6px;display:block">N√∫mero do Romaneio (1¬™ vez)</label>
          <input id="first_romaneio" type="text" placeholder="N√∫mero do romaneio" style="padding:8px;border-radius:6px;border:1px solid #ddd;width:100%" />
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px">
          <button id="btnSaveInitial" style="background:var(--primary);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer">Salvar e Continuar</button>
        </div>
      `;
      document.getElementById('btnSaveInitial').addEventListener('click', () => {
        const fm = document.getElementById('first_motorista').value.trim();
        const fr = document.getElementById('first_romaneio').value.trim();
        if (!fm){ alert('Informe o nome do motorista.'); return; }
        if (!fr){ alert('Informe o n√∫mero do romaneio.'); return; }
        localStorage.setItem(KEY_MOTORISTA, fm);
        localStorage.setItem(KEY_ROMANEIO, fr);
        renderMotoristaBlock();
      });
    } else {
      motoristaBlock.innerHTML = `
        <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;width:100%">
          <div style="min-width:160px">
            <div class="label">Motorista</div>
            <input readonly value="${escapeHtml(motorista)}" style="padding:8px;border-radius:6px;border:1px solid #e6e6e6;width:100%" />
          </div>
          <div style="min-width:140px">
            <div class="label">Romaneio</div>
            <input readonly value="${escapeHtml(romaneio)}" style="padding:8px;border-radius:6px;border:1px solid #e6e6e6;width:100%" />
          </div>
          <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
            <button onclick="apagarMotoristaRomaneio()" class="delete-btn" title="Apagar Motorista e Romaneio">üóëÔ∏è Apagar Motorista/Romaneio</button>
          </div>
        </div>
      `;
    }
  }

  function atualizarResumoUI(){
    const regs = carregarRegistros();
    const total = regs.length;
    const soma = regs.reduce((s,r) => s + (Number(r.valor) || 0), 0);
    topSummary.innerText = `Total: ${total} ‚Äî Soma: ${formatBRL(soma)}`;
  }

  function renderTable(){
    const regs = carregarRegistros();
    if (regs.length === 0){
      tabelaContainer.innerHTML = '<p><em>Nenhum registro ainda.</em></p>';
      atualizarResumoUI();
      return;
    }
    const motorista = localStorage.getItem(KEY_MOTORISTA) || '';
    const romaneio = localStorage.getItem(KEY_ROMANEIO) || '';
    let html = '<table><thead><tr><th>Motorista</th><th>Romaneio</th><th>Cliente</th><th>Data do PIX</th><th>Valor</th><th>Conferido por</th><th>A√ß√µes</th></tr></thead><tbody>';
    regs.forEach((r, idx) => {
      html += `<tr>
        <td>${escapeHtml(motorista)}</td>
        <td>${escapeHtml(romaneio)}</td>
        <td>${escapeHtml(r.cliente)}</td>
        <td>${escapeHtml(r.dataPix)}</td>
        <td>${formatBRL(r.valor)}</td>
        <td>${escapeHtml(r.conferidoPor||'')}</td>
        <td class="actions"><button class="delete-btn" onclick="deleteRegistro(${idx})">Apagar</button></td>
      </tr>`;
    });
    html += `</tbody><tfoot><tr><th colspan="4">Total</th><th>${formatBRL(regs.reduce((s,r)=>s+Number(r.valor),0))}</th><th colspan="2">${regs.length} lan√ßamento(s)</th></tr></tfoot></table>`;
    tabelaContainer.innerHTML = html;
    atualizarResumoUI();
  }

  window.deleteRegistro = function(index){
    if (!confirm('Apagar este registro?')) return;
    const regs = carregarRegistros();
    regs.splice(index,1);
    salvarRegistros(regs);
    renderTable();
  };

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const cliente = document.getElementById('cliente').value.trim();
    const dataPix = document.getElementById('dataPix').value;
    const valorRaw = document.getElementById('valorPix').value;
    const conferidoPor = document.getElementById('conferidoPor').value.trim();

    if (!localStorage.getItem(KEY_MOTORISTA) || !localStorage.getItem(KEY_ROMANEIO)){
      alert('Motorista e Romaneio ainda n√£o foram configurados.');
      return;
    }
    if (!cliente){ alert('Informe o nome do cliente.'); return; }
    if (!dataPix){ alert('Informe a data do PIX.'); return; }
    const valorNum = parseBRL(valorRaw);
    if (valorNum <= 0){ alert('Informe um valor v√°lido.'); return; }

    const registro = { cliente, dataPix, valor: Number(valorNum), conferidoPor, timestamp: new Date().toISOString() };
    const regs = carregarRegistros();
    regs.push(registro);
    salvarRegistros(regs);
    form.reset();
    document.getElementById('valorPix').value = '';
    renderTable();
  });

  window.limparTudo = function(){
    if (!confirm('Deseja apagar TODOS os registros?')) return;
    localStorage.removeItem(KEY_REGS);
    renderTable();
  };

  window.apagarMotoristaRomaneio = function(){
    if (!confirm('Tem certeza que deseja apagar o Motorista e o Romaneio?')) return;
    localStorage.removeItem(KEY_MOTORISTA);
    localStorage.removeItem(KEY_ROMANEIO);
    renderMotoristaBlock();
  };

  function exportarExcel() {
    const regs = carregarRegistros();
    if (regs.length === 0) return alert('Nenhum registro para exportar.');
    const motorista = localStorage.getItem(KEY_MOTORISTA) || '';
    const romaneio = localStorage.getItem(KEY_ROMANEIO) || '';
    const data = regs.map(r => ({
      Motorista: motorista,
      Romaneio: romaneio,
      Cliente: r.cliente,
      'Data do PIX': r.dataPix,
      Valor: r.valor,
      'Conferido por': r.conferidoPor
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Entradas PIX');
    XLSX.writeFile(wb, `PABLO_GAME_SHOW_${motorista}_${romaneio}.xlsx`);
  }

  function imprimirResumo() {
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html><head><title>CONTROLE DE PIX ALIAN√áA - Resumo</title></head><body>
      <h2>CONTROLE DE PIX ALIAN√áA</h2>
      <h4>Motorista: ${localStorage.getItem(KEY_MOTORISTA) || ''}</h4>
      <h4>Romaneio: ${localStorage.getItem(KEY_ROMANEIO) || ''}</h4>
      ${document.getElementById('tabela-container').innerHTML}
      </body></html>
    `);
    printWindow.document.close();
    printWindow.print();
  }

  renderMotoristaBlock();
  renderTable();
  atualizarResumoUI();
  </script>
</body>
</html>
